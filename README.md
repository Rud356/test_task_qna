# test_task_qna
Тестовое задание для Хайталент

## Реализуемый функционал
Сервер для создания вопросов и ответов на отдельные вопросы.

## Установка из исходного кода
Предварительные требования:
- Установленный Python 3.13
- Установленный Docker и Docker-compose

Шаги установки:
1. Создать виртуальное окружение на основе Python 3.13 командой python -m venv venv
2. Активировать виртуальное окружение командой:
   1. Для Windows `./venv/Scripts/activate`
   2. Для Linux: `source ./venv/bin/activate`
3. Запустить базу данных при помощи Docker-compos e из корневой папки проекта командой `docker-compose up -d db_server`
4. Выполнить установку зависимостей с помощью 
`pip install -e .[migration]`
(или `pip install -e .[migration,dev]` для зависимостей во время тестирования и линтеров)
5. Выполнить миграции командой  alembic upgrade head
6. Запустить сервер командой python -m src.qna_server 
(сервер запускается на порте 7999, конфигурация хранится в файле config.toml)

Для запуска тестов необходимо установить зависимости для разработчиков при помощи команды 
`pip install -e .[migration,dev]`, после чего можно выполнить команду `pytest ./tests` из корня проекта.
Конфигурация для тестового окружения располагается в папке ./tests в файле по пути `./tests/test_config.toml`.

## Установка при помощи docker-compose
Предварительные требования:
- Установленный Docker и Docker-compose

Данный тип установки применяет передачу данных через файлы docker_config.toml и docker_alembic.ini в файлах проекта, 
передавая их в контейнер под именами config.toml и alembic.ini для конфигурации основного сервера. 

Для запуска необходимо выполнить следующие команды:
1. `docker-compose up` - Предварительная установка и запуск сервисов с выводом информации из контейнеров
2. `docker exec -it qna_backend alembic upgrade head` - запуск миграций БД

## Настройка логирования
По умолчанию логирование настроено отображать сообщения начиная с уровня INFO (исключая DEBUG) 
и выводит результаты в консоль.

Файл конфигурации логирования располагается по пути `./logging.conf` в стандартном формате для модуля 
logging языка Python.

Также логируется вместе с информацией о запросах и информация о ходе выполнения работы с БД, с привязкой
переменной context_id в формате вывода `Context ID [<context_id>]` для обеспечения отслеживания логов, полученных в рамках
выполнения обработки одного HTTP-запроса.

## Взаимодействие с сервером
Сервер запускается по умолчанию с возможностью принимать запросы с любых IP-адресов, и доступен по адресу 
http://localhost:7999

Документация по API располагается на ресурса http://localhost:7999/docs с возможностью интерактивного взаимодействия.

В рамках задания реализованы следующие конечные точки:

| Метод  | Конечная точка                    | Описание                                                     |
|:-------|:----------------------------------|:-------------------------------------------------------------|
| GET    | /questions/                       | Получение списка вопросов                                    |
| POST   | /questions/                       | Создание нового вопроса                                      |
| GET    | /questions/{question_id}          | Получение отдельного вопроса и всех ответов, связанных с ним |
| DELETE | /questions/{question_id}          | Удаление вопроса и всех связанных ответов из системы         |
| POST   | /questions/{question_id}/answers/ | Создание нового ответа на вопрос                             |
| GET    | /answers/{answer_id}              | Получение отдельного ответа на вопрос                        |
| DELETE | /answers/{answer_id}              | Удаление ответа на вопрос                                    |

Создание ответа на несуществующий вопрос приводит к ответу 404 ошибкой с сообщением о том, что такой вопрос не найден.

Пользователь обозначается с помощью строки, проверяемой на валидность при помощи ограничений 
Pydantic и регулярного выражения, и количество ответов одного пользователя на вопрос не ограничено.

Удаление одного вопроса каскадно удаляет все связанные ответы, 
что тестируется отдельным тестом в модуле test_question_repo. 

## Описание структуры проекта

### Корень проекта
Содержит файлы конфигурации отдельных инструментов, а именно:
- alembic.ini и alembic_docker.ini для конфигурирования инструмента миграции схем БД без и с докером соответственно
- config.toml и config_docker.toml для конфигурирования сервера, запущенного без докера и с докером
- Dockerfile и docker-compose.yaml для описания упаковки сервера и зависимостей для его запуска
- logging.conf управляющий конфигурацией логгирования на сервере
- pyproject.toml конфигурирующий проект как установочный пакет для pip
- pytest.ini конфигурирует pytest для использования асинхронных сессий под тестирование асинхронного кода

### Папка .github
Содержит файл описания CI пайплайна для тестирования и линтинга кода, 
запускаемого автоматически при коммите в основную ветку.

### Папка migrations
Содержит файлы, созданные при помощи alembic для проведения миграций БД при изменении схем.

### Папка src
Содержит основной код проекта в папке qna_server, от которой описываются все последующие папки в виде модулей.

#### Модуль api
Содержит описание сервера FastAPI приложения и функцию для его настройки и запуска.

##### Подмодуль api.endpoints
Содержит файлы с описанием конечных точек приложения на FastAPI и обработкой запросов.

#### Модуль custom_types
Содержит описания для типа данных custom_id и дополнительных данных для логгирования стандартным модулем logging.

#### Модуль dto
Содержит описания моделей Pydantic, помогающих описать передаваемые между слоями приложения данные, а также обеспечивающий
валидацию этих данных.

#### Модуль exceptions
Описывает существующие в сервере типы исключений.

#### Модуль storage
Описывает протоколы (посредствам подмодуля protocol) допустимых операций с БД
в виде целостной логически и по операциям единицы в рамках транзакции через объекты-репозитории.

В рамках подмодуля sqla_implementation описывается конкретная реализация для ORM SQLAlchemy.

Данный модуль занимается только получением, изменением и сохранением данных в БД без применения бизнес-логики.

#### Модуль use_cases
Содержит бизнес-логику приложения, реализуемую поверх репозиториев, обеспечивающих только получение, сохранение и изменение
данных в БД, без реализации дополнительных проверок. Данный модуль характеризуется отвязкой от конкретной реализации
посредствам использования протоколов из модуля storage.


#### Модуль utils
Содержит описание формата конфигурационного файла сервера, а также объектов для Dependency Injection.

### Папка tests
Содержит тестовую конфигурацию в файле test_config.toml, а также модуль с тестами test_sqla_repo для обеспечения
тестирования логики работы с БД через репозитории.


## Технологический стек
В проекте применяются следующие библиотеки:
- FastAPI
- Pydantic 2
- SQLAlchemy 2.0
- alembic
- dishka
- pytest и pytest-async
- mypy (в режиме строгой валидации типизации --strict)
- ruff (линтер для обеспечения форматирования кода по образцу)
- sphinx-lint (проверка оформления документации в коде)